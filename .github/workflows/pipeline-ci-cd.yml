# ✅ Name of the Workflow
name: Pipeline CI/CD frontend-app

# ✅ Trigger this workflow on push to main branch
on:
  push:
    branches:
      - main

# ✅ Global Environment Variables
env:
  Docker_IMAGE: ${{ secrets.DOCKERHUB_USERNAME }}/frontfontend-app
  VITE_API_URL: https://backend.app.26.lebondeveloppeur.net
jobs:
  # ✅ Run Unit Tests
  unit-test-job:
    runs-on: ubuntu-latest
    steps:
      - name: clone Source Code
        uses: actions/checkout@v5

      - name: Set up Node.js
        uses: actions/setup-node@v3
        with:
          node-version: "18"

      - name: install dependencies
        run: npm i

      - name: run unit test
        run: npm run test

      # ✅ Docker build
  build-docker-image-and-push:
    runs-on: ubuntu-latest
    needs: unit-test-job
    steps:
      - name: clone code source
        uses: actions/checkout@v5

      - name: build docker image
        run: docker build -t  ${{ env.Docker_IMAGE }} --build-arg VITE_API_URL=${{ env.VITE_API_URL }} .
      - name: login to docker hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}
      - name: Push Docker image
        run: docker push ${{ env.IMAGE_NAME }}

  deploy-to-vps:
        runs-on: ubuntu-latest
        needs: build-docker-image-and-push
        steps:
            - name: Execute remote SSH commands using password
              uses: appleboy/ssh-action@v1
              with:
                host: ${{ secrets.VPS_HOST }}
                username: user
                password: ${{ secrets.VPS_PASSWORD }}
                script: |
                  cd /home/user/session13/devops_script/frontend-app/dev
                  sudo docker compose pull
                  sudo docker compose up -d --force-recreate --remove-orphans
 
